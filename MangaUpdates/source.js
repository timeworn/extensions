"use strict";
var _Sources = (() => {
  var __create = Object.create;
  var __defProp = Object.defineProperty;
  var __getOwnPropDesc = Object.getOwnPropertyDescriptor;
  var __getOwnPropNames = Object.getOwnPropertyNames;
  var __getProtoOf = Object.getPrototypeOf;
  var __hasOwnProp = Object.prototype.hasOwnProperty;
  var __commonJS = (cb, mod) => function __require() {
    return mod || (0, cb[__getOwnPropNames(cb)[0]])((mod = { exports: {} }).exports, mod), mod.exports;
  };
  var __export = (target, all) => {
    for (var name in all)
      __defProp(target, name, { get: all[name], enumerable: true });
  };
  var __copyProps = (to, from, except, desc) => {
    if (from && typeof from === "object" || typeof from === "function") {
      for (let key of __getOwnPropNames(from))
        if (!__hasOwnProp.call(to, key) && key !== except)
          __defProp(to, key, { get: () => from[key], enumerable: !(desc = __getOwnPropDesc(from, key)) || desc.enumerable });
    }
    return to;
  };
  var __toESM = (mod, isNodeMode, target) => (target = mod != null ? __create(__getProtoOf(mod)) : {}, __copyProps(
    // If the importer is in node compatibility mode or this is not an ESM
    // file that has been converted to a CommonJS file using a Babel-
    // compatible transform (i.e. "__esModule" has not been set), then set
    // "default" to the CommonJS "module.exports" for node compatibility.
    isNodeMode || !mod || !mod.__esModule ? __defProp(target, "default", { value: mod, enumerable: true }) : target,
    mod
  ));
  var __toCommonJS = (mod) => __copyProps(__defProp({}, "__esModule", { value: true }), mod);

  // node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUIBinding.js
  var require_DUIBinding = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUIBinding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUIForm.js
  var require_DUIForm = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUIForm.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUIFormRow.js
  var require_DUIFormRow = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUIFormRow.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUISection.js
  var require_DUISection = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Exports/DUISection.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIButton.js
  var require_DUIButton = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIButton.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIHeader.js
  var require_DUIHeader = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIHeader.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIInputField.js
  var require_DUIInputField = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIInputField.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUILabel.js
  var require_DUILabel = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUILabel.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUILink.js
  var require_DUILink = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUILink.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIMultilineLabel.js
  var require_DUIMultilineLabel = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIMultilineLabel.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUINavigationButton.js
  var require_DUINavigationButton = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUINavigationButton.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIOAuthButton.js
  var require_DUIOAuthButton = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIOAuthButton.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUISecureInputField.js
  var require_DUISecureInputField = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUISecureInputField.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUISelect.js
  var require_DUISelect = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUISelect.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIStepper.js
  var require_DUIStepper = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUIStepper.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUISwitch.js
  var require_DUISwitch = __commonJS({
    "node_modules/@paperback/types/lib/generated/DynamicUI/Rows/Exports/DUISwitch.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/ChapterDetails.js
  var require_ChapterDetails = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/ChapterDetails.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/Chapter.js
  var require_Chapter = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/Chapter.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/Cookie.js
  var require_Cookie = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/Cookie.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/HomeSection.js
  var require_HomeSection = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/HomeSection.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/IconText.js
  var require_IconText = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/IconText.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/MangaInfo.js
  var require_MangaInfo = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/MangaInfo.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/MangaProgress.js
  var require_MangaProgress = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/MangaProgress.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/PartialSourceManga.js
  var require_PartialSourceManga = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/PartialSourceManga.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/MangaUpdates.js
  var require_MangaUpdates = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/MangaUpdates.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/PBCanvas.js
  var require_PBCanvas = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/PBCanvas.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/PBImage.js
  var require_PBImage = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/PBImage.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/PagedResults.js
  var require_PagedResults = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/PagedResults.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/RawData.js
  var require_RawData = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/RawData.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/Request.js
  var require_Request = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/Request.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/SourceInterceptor.js
  var require_SourceInterceptor = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/SourceInterceptor.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/RequestManager.js
  var require_RequestManager = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/RequestManager.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/Response.js
  var require_Response = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/Response.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/SearchField.js
  var require_SearchField = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/SearchField.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/SearchRequest.js
  var require_SearchRequest = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/SearchRequest.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/SourceCookieStore.js
  var require_SourceCookieStore = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/SourceCookieStore.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/SourceManga.js
  var require_SourceManga = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/SourceManga.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/SecureStateManager.js
  var require_SecureStateManager = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/SecureStateManager.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/SourceStateManager.js
  var require_SourceStateManager = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/SourceStateManager.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/Tag.js
  var require_Tag = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/Tag.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/TagSection.js
  var require_TagSection = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/TagSection.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/TrackedMangaChapterReadAction.js
  var require_TrackedMangaChapterReadAction = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/TrackedMangaChapterReadAction.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/Exports/TrackerActionQueue.js
  var require_TrackerActionQueue = __commonJS({
    "node_modules/@paperback/types/lib/generated/Exports/TrackerActionQueue.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/generated/_exports.js
  var require_exports = __commonJS({
    "node_modules/@paperback/types/lib/generated/_exports.js"(exports) {
      "use strict";
      var __createBinding = exports && exports.__createBinding || (Object.create ? function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        var desc = Object.getOwnPropertyDescriptor(m, k);
        if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
          desc = { enumerable: true, get: function() {
            return m[k];
          } };
        }
        Object.defineProperty(o, k2, desc);
      } : function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        o[k2] = m[k];
      });
      var __exportStar = exports && exports.__exportStar || function(m, exports2) {
        for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports2, p)) __createBinding(exports2, m, p);
      };
      Object.defineProperty(exports, "__esModule", { value: true });
      __exportStar(require_DUIBinding(), exports);
      __exportStar(require_DUIForm(), exports);
      __exportStar(require_DUIFormRow(), exports);
      __exportStar(require_DUISection(), exports);
      __exportStar(require_DUIButton(), exports);
      __exportStar(require_DUIHeader(), exports);
      __exportStar(require_DUIInputField(), exports);
      __exportStar(require_DUILabel(), exports);
      __exportStar(require_DUILink(), exports);
      __exportStar(require_DUIMultilineLabel(), exports);
      __exportStar(require_DUINavigationButton(), exports);
      __exportStar(require_DUIOAuthButton(), exports);
      __exportStar(require_DUISecureInputField(), exports);
      __exportStar(require_DUISelect(), exports);
      __exportStar(require_DUIStepper(), exports);
      __exportStar(require_DUISwitch(), exports);
      __exportStar(require_ChapterDetails(), exports);
      __exportStar(require_Chapter(), exports);
      __exportStar(require_Cookie(), exports);
      __exportStar(require_HomeSection(), exports);
      __exportStar(require_IconText(), exports);
      __exportStar(require_MangaInfo(), exports);
      __exportStar(require_MangaProgress(), exports);
      __exportStar(require_PartialSourceManga(), exports);
      __exportStar(require_MangaUpdates(), exports);
      __exportStar(require_PBCanvas(), exports);
      __exportStar(require_PBImage(), exports);
      __exportStar(require_PagedResults(), exports);
      __exportStar(require_RawData(), exports);
      __exportStar(require_Request(), exports);
      __exportStar(require_SourceInterceptor(), exports);
      __exportStar(require_RequestManager(), exports);
      __exportStar(require_Response(), exports);
      __exportStar(require_SearchField(), exports);
      __exportStar(require_SearchRequest(), exports);
      __exportStar(require_SourceCookieStore(), exports);
      __exportStar(require_SourceManga(), exports);
      __exportStar(require_SecureStateManager(), exports);
      __exportStar(require_SourceStateManager(), exports);
      __exportStar(require_Tag(), exports);
      __exportStar(require_TagSection(), exports);
      __exportStar(require_TrackedMangaChapterReadAction(), exports);
      __exportStar(require_TrackerActionQueue(), exports);
    }
  });

  // node_modules/@paperback/types/lib/base/Source.js
  var require_Source = __commonJS({
    "node_modules/@paperback/types/lib/base/Source.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
      exports.urlEncodeObject = exports.convertTime = exports.Source = void 0;
      var Source = class {
        constructor(cheerio) {
          this.cheerio = cheerio;
        }
        /**
         * @deprecated use {@link Source.getSearchResults getSearchResults} instead
         */
        searchRequest(query, metadata) {
          return this.getSearchResults(query, metadata);
        }
        /**
         * @deprecated use {@link Source.getSearchTags} instead
         */
        async getTags() {
          return this.getSearchTags?.();
        }
      };
      exports.Source = Source;
      function convertTime(timeAgo) {
        let time;
        let trimmed = Number((/\d*/.exec(timeAgo) ?? [])[0]);
        trimmed = trimmed == 0 && timeAgo.includes("a") ? 1 : trimmed;
        if (timeAgo.includes("minutes")) {
          time = new Date(Date.now() - trimmed * 6e4);
        } else if (timeAgo.includes("hours")) {
          time = new Date(Date.now() - trimmed * 36e5);
        } else if (timeAgo.includes("days")) {
          time = new Date(Date.now() - trimmed * 864e5);
        } else if (timeAgo.includes("year") || timeAgo.includes("years")) {
          time = new Date(Date.now() - trimmed * 31556952e3);
        } else {
          time = new Date(Date.now());
        }
        return time;
      }
      exports.convertTime = convertTime;
      function urlEncodeObject(obj) {
        let ret = {};
        for (const entry of Object.entries(obj)) {
          ret[encodeURIComponent(entry[0])] = encodeURIComponent(entry[1]);
        }
        return ret;
      }
      exports.urlEncodeObject = urlEncodeObject;
    }
  });

  // node_modules/@paperback/types/lib/base/ByteArray.js
  var require_ByteArray = __commonJS({
    "node_modules/@paperback/types/lib/base/ByteArray.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/Badge.js
  var require_Badge = __commonJS({
    "node_modules/@paperback/types/lib/base/Badge.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
      exports.BadgeColor = void 0;
      var BadgeColor;
      (function(BadgeColor2) {
        BadgeColor2["BLUE"] = "default";
        BadgeColor2["GREEN"] = "success";
        BadgeColor2["GREY"] = "info";
        BadgeColor2["YELLOW"] = "warning";
        BadgeColor2["RED"] = "danger";
      })(BadgeColor = exports.BadgeColor || (exports.BadgeColor = {}));
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/ChapterProviding.js
  var require_ChapterProviding = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/ChapterProviding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/CloudflareBypassRequestProviding.js
  var require_CloudflareBypassRequestProviding = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/CloudflareBypassRequestProviding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/HomePageSectionsProviding.js
  var require_HomePageSectionsProviding = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/HomePageSectionsProviding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/MangaProgressProviding.js
  var require_MangaProgressProviding = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/MangaProgressProviding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/MangaProviding.js
  var require_MangaProviding = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/MangaProviding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/RequestManagerProviding.js
  var require_RequestManagerProviding = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/RequestManagerProviding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/SearchResultsProviding.js
  var require_SearchResultsProviding = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/SearchResultsProviding.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/interfaces/index.js
  var require_interfaces = __commonJS({
    "node_modules/@paperback/types/lib/base/interfaces/index.js"(exports) {
      "use strict";
      var __createBinding = exports && exports.__createBinding || (Object.create ? function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        var desc = Object.getOwnPropertyDescriptor(m, k);
        if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
          desc = { enumerable: true, get: function() {
            return m[k];
          } };
        }
        Object.defineProperty(o, k2, desc);
      } : function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        o[k2] = m[k];
      });
      var __exportStar = exports && exports.__exportStar || function(m, exports2) {
        for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports2, p)) __createBinding(exports2, m, p);
      };
      Object.defineProperty(exports, "__esModule", { value: true });
      __exportStar(require_ChapterProviding(), exports);
      __exportStar(require_CloudflareBypassRequestProviding(), exports);
      __exportStar(require_HomePageSectionsProviding(), exports);
      __exportStar(require_MangaProgressProviding(), exports);
      __exportStar(require_MangaProviding(), exports);
      __exportStar(require_RequestManagerProviding(), exports);
      __exportStar(require_SearchResultsProviding(), exports);
    }
  });

  // node_modules/@paperback/types/lib/base/SourceInfo.js
  var require_SourceInfo = __commonJS({
    "node_modules/@paperback/types/lib/base/SourceInfo.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
      exports.ContentRating = exports.SourceIntents = void 0;
      var SourceIntents2;
      (function(SourceIntents3) {
        SourceIntents3[SourceIntents3["MANGA_CHAPTERS"] = 1] = "MANGA_CHAPTERS";
        SourceIntents3[SourceIntents3["MANGA_TRACKING"] = 2] = "MANGA_TRACKING";
        SourceIntents3[SourceIntents3["HOMEPAGE_SECTIONS"] = 4] = "HOMEPAGE_SECTIONS";
        SourceIntents3[SourceIntents3["COLLECTION_MANAGEMENT"] = 8] = "COLLECTION_MANAGEMENT";
        SourceIntents3[SourceIntents3["CLOUDFLARE_BYPASS_REQUIRED"] = 16] = "CLOUDFLARE_BYPASS_REQUIRED";
        SourceIntents3[SourceIntents3["SETTINGS_UI"] = 32] = "SETTINGS_UI";
      })(SourceIntents2 = exports.SourceIntents || (exports.SourceIntents = {}));
      var ContentRating2;
      (function(ContentRating3) {
        ContentRating3["EVERYONE"] = "EVERYONE";
        ContentRating3["MATURE"] = "MATURE";
        ContentRating3["ADULT"] = "ADULT";
      })(ContentRating2 = exports.ContentRating || (exports.ContentRating = {}));
    }
  });

  // node_modules/@paperback/types/lib/base/HomeSectionType.js
  var require_HomeSectionType = __commonJS({
    "node_modules/@paperback/types/lib/base/HomeSectionType.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
      exports.HomeSectionType = void 0;
      var HomeSectionType;
      (function(HomeSectionType2) {
        HomeSectionType2["singleRowNormal"] = "singleRowNormal";
        HomeSectionType2["singleRowLarge"] = "singleRowLarge";
        HomeSectionType2["doubleRow"] = "doubleRow";
        HomeSectionType2["featured"] = "featured";
      })(HomeSectionType = exports.HomeSectionType || (exports.HomeSectionType = {}));
    }
  });

  // node_modules/@paperback/types/lib/base/PaperbackExtensionBase.js
  var require_PaperbackExtensionBase = __commonJS({
    "node_modules/@paperback/types/lib/base/PaperbackExtensionBase.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/base/index.js
  var require_base = __commonJS({
    "node_modules/@paperback/types/lib/base/index.js"(exports) {
      "use strict";
      var __createBinding = exports && exports.__createBinding || (Object.create ? function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        var desc = Object.getOwnPropertyDescriptor(m, k);
        if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
          desc = { enumerable: true, get: function() {
            return m[k];
          } };
        }
        Object.defineProperty(o, k2, desc);
      } : function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        o[k2] = m[k];
      });
      var __exportStar = exports && exports.__exportStar || function(m, exports2) {
        for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports2, p)) __createBinding(exports2, m, p);
      };
      Object.defineProperty(exports, "__esModule", { value: true });
      __exportStar(require_Source(), exports);
      __exportStar(require_ByteArray(), exports);
      __exportStar(require_Badge(), exports);
      __exportStar(require_interfaces(), exports);
      __exportStar(require_SourceInfo(), exports);
      __exportStar(require_HomeSectionType(), exports);
      __exportStar(require_PaperbackExtensionBase(), exports);
    }
  });

  // node_modules/@paperback/types/lib/compat/DyamicUI.js
  var require_DyamicUI = __commonJS({
    "node_modules/@paperback/types/lib/compat/DyamicUI.js"(exports) {
      "use strict";
      Object.defineProperty(exports, "__esModule", { value: true });
    }
  });

  // node_modules/@paperback/types/lib/index.js
  var require_lib = __commonJS({
    "node_modules/@paperback/types/lib/index.js"(exports) {
      "use strict";
      var __createBinding = exports && exports.__createBinding || (Object.create ? function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        var desc = Object.getOwnPropertyDescriptor(m, k);
        if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
          desc = { enumerable: true, get: function() {
            return m[k];
          } };
        }
        Object.defineProperty(o, k2, desc);
      } : function(o, m, k, k2) {
        if (k2 === void 0) k2 = k;
        o[k2] = m[k];
      });
      var __exportStar = exports && exports.__exportStar || function(m, exports2) {
        for (var p in m) if (p !== "default" && !Object.prototype.hasOwnProperty.call(exports2, p)) __createBinding(exports2, m, p);
      };
      Object.defineProperty(exports, "__esModule", { value: true });
      __exportStar(require_exports(), exports);
      __exportStar(require_base(), exports);
      __exportStar(require_DyamicUI(), exports);
    }
  });

  // src/MangaUpdates/MangaUpdates.ts
  var MangaUpdates_exports = {};
  __export(MangaUpdates_exports, {
    MangaUpdates: () => MangaUpdates,
    MangaUpdatesInfo: () => MangaUpdatesInfo
  });
  var import_types = __toESM(require_lib());

  // src/MangaUpdates/utils/mu-session.ts
  var logPrefix = "[mu-session]";
  var STATE_MU_CREDENTIALS = "mu_credentials";
  var STATE_MU_SESSION = "mu_sessiontoken";
  function validateCredentials(credentials) {
    return credentials != null && typeof credentials === "object" && typeof credentials.username === "string" && typeof credentials.password === "string";
  }
  async function getUserCredentials(stateManager) {
    const credentialsString = await stateManager.keychain.retrieve(STATE_MU_CREDENTIALS);
    if (typeof credentialsString !== "string") {
      return void 0;
    }
    const credentials = JSON.parse(credentialsString);
    if (!validateCredentials(credentials)) {
      console.log(`${logPrefix} store contains invalid credentials!`);
      return void 0;
    }
    return credentials;
  }
  async function setUserCredentials(stateManager, credentials) {
    if (!validateCredentials(credentials)) {
      console.log(`${logPrefix} tried to store invalid mu_credentials: ${JSON.stringify(credentials)}`);
      throw new Error("tried to store invalid mu_credentials");
    }
    await stateManager.keychain.store(STATE_MU_CREDENTIALS, JSON.stringify(credentials));
  }
  async function clearUserCredentials(stateManager) {
    await stateManager.keychain.store(STATE_MU_CREDENTIALS, void 0);
  }
  async function getSessionToken(stateManager) {
    const sessionToken = await stateManager.keychain.retrieve(STATE_MU_SESSION);
    return typeof sessionToken === "string" ? sessionToken : void 0;
  }
  async function setSessionToken(stateManager, sessionToken) {
    if (typeof sessionToken !== "string") {
      console.log(`${logPrefix} tried to store invalid mu_sessiontoken: ${sessionToken}`);
      throw new Error("tried to store invalid mu_sessiontoken");
    }
    await stateManager.keychain.store(STATE_MU_SESSION, sessionToken);
  }
  async function clearSessionToken(stateManager) {
    await stateManager.keychain.store(STATE_MU_SESSION, void 0);
  }
  function getLoginTime(sessionToken) {
    if (!sessionToken) {
      return "-";
    }
    try {
      const payloadBase64 = sessionToken.split(".")[1] || "";
      const payloadJson = Buffer.from(payloadBase64, "base64").toString();
      const payload = JSON.parse(payloadJson);
      const loginTime = new Date(payload.time_created * 1e3);
      if (isNaN(loginTime.getTime())) {
        throw new Error("invalid date");
      }
      return loginTime.toLocaleString();
    } catch (e) {
      console.log(`${logPrefix} failed to parse login time`);
      console.log(e);
      return "-";
    }
  }
  function loggableRequest(request) {
    let censoredRequest = request;
    if (censoredRequest.body?.password) {
      censoredRequest = {
        ...request,
        body: {
          ...request.body,
          password: "***"
        }
      };
    }
    if (censoredRequest.params?.authHash) {
      censoredRequest = {
        ...censoredRequest,
        params: {
          ...censoredRequest.params,
          authHash: "***"
        }
      };
    }
    return JSON.stringify(censoredRequest);
  }
  function loggableResponse(response) {
    if (!response) {
      return "<empty>";
    }
    let censoredResponse = response;
    if (censoredResponse.context?.session_token) {
      censoredResponse = {
        ...censoredResponse,
        context: {
          ...censoredResponse.context,
          session_token: "***"
        }
      };
    }
    return JSON.stringify(censoredResponse);
  }

  // src/MangaUpdates/utils/mu-manga.ts
  var HTML_ENTITIES = {
    "&nbsp;": " ",
    "&cent;": "\xA2",
    "&pound;": "\xA3",
    "&yen;": "\xA5",
    "&euro;": "\u20AC",
    "&copy;": "\xA9",
    "&reg;": "\xAE",
    "&lt;": "<",
    "&gt;": ">",
    "&quot;": '"',
    "&amp;": "&",
    "&apos;": "'"
  };
  var IS_HENTAI_GENRE = {
    Adult: true,
    Hentai: true,
    Smut: true
  };
  function parseStatus(status) {
    const statusMatches = /\(([a-zA-Z]+)\)/g.exec(status)?.slice(1).map((match) => match.toLowerCase()) || [];
    if (statusMatches.some((match) => match.includes("ongoing"))) {
      return "ONGOING";
    }
    if (statusMatches.some((match) => match.includes("hiatus"))) {
      return "HIATUS";
    }
    if (statusMatches.some((match) => match.includes("incomplete") || match.includes("discontinued"))) {
      return "ABANDONED";
    }
    if (statusMatches.some((match) => match.includes("complete"))) {
      return "COMPLETED";
    }
    return "UNKNOWN";
  }
  function isHentai(manga) {
    return manga.genres?.some((genre) => IS_HENTAI_GENRE[genre?.genre || ""]) || false;
  }
  function sanitiseString(str) {
    return str.replace(/&[^;]+;/g, (entity) => {
      if (entity in HTML_ENTITIES) {
        return HTML_ENTITIES[entity];
      }
      const hexMatch = entity.match(/^&#x([\da-fA-F]+);$/);
      const hexCode = hexMatch != null ? hexMatch[1] : void 0;
      if (hexCode != null) {
        return String.fromCharCode(parseInt(hexCode, 16));
      }
      const decimalMatch = entity.match(/^&#(\d+);$/);
      const decimalCode = decimalMatch != null ? decimalMatch[1] : void 0;
      if (decimalCode != null) {
        return String.fromCharCode(parseInt(decimalCode, 10));
      }
      return entity;
    }).replace(/<br>/gi, "\n").replace(/<\/?(i|u|b|em|a|span|div|!--)[^>]*>/gi, "");
  }
  function parseMangaInfo(series) {
    return {
      titles: [series.title, ...(series.associated || []).map((associated) => associated?.title)].filter((title) => !!title).map(sanitiseString),
      desc: sanitiseString(series.description || ""),
      image: series.image?.url?.original || "",
      author: series.authors?.filter((author) => author?.type === "Author" && author.name).map((author) => author.name).join(", ") || "Unknown",
      artist: series.authors?.filter((author) => author?.type === "Artist" && author.name).map((author) => author.name).join(", ") || "Unknown",
      // The type for `status` is lies - it actually expects the string name of the enum value
      // eslint-disable-next-line @typescript-eslint/no-explicit-any
      status: parseStatus(series.status || ""),
      rating: series?.bayesian_rating,
      hentai: isHentai(series)
    };
  }
  function assertNotLegacyMangaId(mangaId) {
    if (mangaId.length <= 6) {
      throw new Error("This manga is tracked using a legacy ID. Please un-track and re-track it");
    }
  }

  // src/MangaUpdates/utils/mu-search.ts
  function parseSearchResults(results) {
    return results.map((result) => {
      const id = result.record?.series_id;
      const title = result.hit_title;
      const image = result.record?.image?.url?.original ?? "";
      if (!id || !title) {
        console.log(`[parseSearchResults] ignoring invalid search result: ${JSON.stringify(result)}`);
        return null;
      }
      return {
        mangaId: String(id),
        title: sanitiseString(title),
        image
      };
    }).filter((info) => info !== null);
  }

  // src/MangaUpdates/MangaUpdates.ts
  var FALLBACK_PROFILE_IMAGE = "https://cdn.mangaupdates.com/avatar/a0.gif";
  var DEFAULT_LIST_ID = 0;
  var MangaUpdatesInfo = {
    name: "MangaUpdates",
    author: "IntermittentlyRupert",
    contentRating: import_types.ContentRating.EVERYONE,
    icon: "icon.png",
    version: "3.0.0",
    description: "MangaUpdates Tracker",
    websiteBaseURL: "https://www.mangaupdates.com",
    intents: import_types.SourceIntents.MANGA_TRACKING | import_types.SourceIntents.SETTINGS_UI
  };
  var MangaUpdates = class {
    constructor() {
      this.stateManager = App.createSourceStateManager();
      this.requestManager = App.createRequestManager({
        requestsPerSecond: 5,
        requestTimeout: 1e4
      });
    }
    ////////////////////
    // Public API
    ////////////////////
    async getMangaDetails(mangaId) {
      const logPrefix2 = "[getMangaDetails]";
      console.log(`${logPrefix2} starts`);
      try {
        console.log(`${logPrefix2} loading id=${mangaId}`);
        const mangaInfo = await this.getMangaInfo(mangaId);
        const trackedManga = App.createSourceManga({
          id: mangaId,
          mangaInfo: App.createMangaInfo(mangaInfo)
        });
        console.log(`${logPrefix2} complete`);
        return trackedManga;
      } catch (e) {
        console.log(`${logPrefix2} error`);
        console.log(e);
        throw e;
      }
    }
    async getMangaProgress(mangaId) {
      const logPrefix2 = "[getMangaProgress]";
      console.log(`${logPrefix2} starts`);
      try {
        console.log(`${logPrefix2} loading id=${mangaId}`);
        assertNotLegacyMangaId(mangaId);
        const [progressInfo, ratingInfo, mangaLists] = await Promise.all([
          this.request("/v1/lists/series/{seriesId}", "GET", { params: { seriesId: mangaId }, query: {} }, false),
          this.request("/v1/series/{id}/rating", "GET", { params: { id: mangaId } }, false),
          this.request("/v1/lists", "GET", {})
        ]);
        if (progressInfo?.list_id == null) {
          console.log(`${logPrefix2} no progress to return`);
          return void 0;
        }
        const progress = App.createMangaProgress({
          mangaId,
          lastReadChapterNumber: progressInfo.status?.chapter ?? 0,
          lastReadVolumeNumber: progressInfo.status?.volume ?? 0,
          trackedListName: mangaLists.find((list) => list.list_id === progressInfo.list_id)?.title ?? "None",
          userRating: ratingInfo?.rating ?? 0
        });
        console.log(`${logPrefix2} complete`);
        return progress;
      } catch (e) {
        console.log(`${logPrefix2} error`);
        console.log(e);
        throw e;
      }
    }
    async getMangaProgressManagementForm(mangaId) {
      let isInList = false;
      return App.createDUIForm({
        sections: async () => {
          try {
            assertNotLegacyMangaId(mangaId);
            const username = (await getUserCredentials(this.stateManager))?.username;
            if (!username) {
              return [
                App.createDUISection({
                  id: "notLoggedInSection",
                  isHidden: false,
                  rows: () => Promise.resolve([
                    App.createDUILabel({
                      id: "notLoggedIn",
                      label: "Not Logged In",
                      value: void 0
                    })
                  ])
                })
              ];
            }
            const [userProfile, mangaInfo, mangaLists, progressInfo, ratingInfo] = await Promise.all([
              this.request("/v1/account/profile", "GET", {}),
              this.getMangaInfo(mangaId),
              this.request("/v1/lists", "GET", {}),
              this.request(
                "/v1/lists/series/{seriesId}",
                "GET",
                { params: { seriesId: mangaId }, query: {} },
                false
              ),
              this.request("/v1/series/{id}/rating", "GET", { params: { id: mangaId } }, false)
            ]);
            const listNamesById = Object.fromEntries([
              ...mangaLists.filter((list) => list.list_id != void 0 && list.title != void 0).map((list) => [String(list.list_id), list.title || ""]),
              ["-1", "None"]
            ]);
            const listOptions = Object.keys(listNamesById);
            isInList = progressInfo != null;
            const listId = String(progressInfo?.list_id ?? -1);
            const chapterProgress = progressInfo?.status?.chapter ?? 0;
            const volumeProgress = progressInfo?.status?.volume ?? 0;
            const userRating = ratingInfo?.rating ?? 0;
            return [
              App.createDUISection({
                id: "userInfo",
                isHidden: false,
                rows: () => Promise.resolve([
                  App.createDUIHeader({
                    id: "header",
                    imageUrl: userProfile.avatar?.url || FALLBACK_PROFILE_IMAGE,
                    title: username,
                    subtitle: "",
                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    //@ts-ignore also accepts a raw value, not just a DUIBinding
                    value: void 0
                  })
                ])
              }),
              App.createDUISection({
                id: "information",
                header: "Information",
                isHidden: false,
                rows: () => Promise.resolve([
                  App.createDUILabel({
                    id: "mangaId",
                    label: "Manga ID",
                    value: mangaId
                  }),
                  App.createDUILabel({
                    id: "mangaTitle",
                    label: "Title",
                    value: mangaInfo.titles[0]
                  }),
                  App.createDUILabel({
                    id: "mangaRating",
                    value: mangaInfo.rating?.toString() ?? "N/A",
                    label: "Rating"
                  }),
                  App.createDUILabel({
                    id: "mangaStatus",
                    value: mangaInfo.status.toString(),
                    label: "Status"
                  }),
                  App.createDUILabel({
                    id: "mangaIsAdult",
                    value: mangaInfo.hentai?.toString() ?? "N/A",
                    label: "Is Adult"
                  })
                ])
              }),
              App.createDUISection({
                id: "trackList",
                header: "Manga List",
                footer: 'Warning: Setting this to "None" will delete the listing from MangaUpdates',
                isHidden: false,
                rows: async () => [
                  App.createDUISelect({
                    id: "listId",
                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    //@ts-ignore also accepts a raw value, not just a DUIBinding
                    value: [listId],
                    allowsMultiselect: false,
                    label: "List",
                    displayLabel: (value) => listNamesById[value] || "<unknown list>",
                    options: listOptions
                  })
                ]
              }),
              App.createDUISection({
                id: "manage",
                header: "Progress",
                isHidden: false,
                rows: () => Promise.resolve([
                  App.createDUIStepper({
                    id: "chapterProgress",
                    label: "Chapter",
                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    //@ts-ignore also accepts a raw value, not just a DUIBinding
                    value: chapterProgress,
                    min: 0,
                    step: 1
                  }),
                  App.createDUIStepper({
                    id: "volumeProgress",
                    label: "Volume",
                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    //@ts-ignore also accepts a raw value, not just a DUIBinding
                    value: volumeProgress,
                    min: 0,
                    step: 1
                  })
                ])
              }),
              App.createDUISection({
                id: "rating",
                header: "User Rating",
                footer: "Warning: Setting this to 0 will delete the rating from MangaUpdates",
                isHidden: false,
                rows: () => Promise.resolve([
                  App.createDUIStepper({
                    id: "userRating",
                    label: "My Rating",
                    // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                    //@ts-ignore also accepts a raw value, not just a DUIBinding
                    value: Math.round(userRating),
                    min: 0,
                    max: 10,
                    step: 1
                  })
                ])
              })
            ];
          } catch (e) {
            console.log("[getMangaForm] failed to render manga form");
            console.log(e);
            return [
              App.createDUISection({
                id: "errorInfo",
                isHidden: false,
                rows: () => Promise.resolve([
                  App.createDUILabel({
                    id: "errorMessage",
                    label: String(e),
                    value: void 0
                  })
                ])
              })
            ];
          }
        },
        onSubmit: (values) => this.handleMangaFormChanges(mangaId, isInList, values)
      });
    }
    async getSourceMenu() {
      return App.createDUISection({
        id: "sourceMenu",
        isHidden: false,
        rows: async () => {
          const [credentials, sessionToken] = await Promise.all([
            getUserCredentials(this.stateManager),
            getSessionToken(this.stateManager)
          ]);
          if (credentials?.username) {
            return [
              App.createDUILabel({
                id: "userInfo",
                label: "Logged-in as",
                value: credentials.username
              }),
              App.createDUILabel({
                id: "loginTime",
                label: "Session started at",
                value: getLoginTime(sessionToken)
              }),
              App.createDUIButton({
                id: "refresh",
                label: "Refresh session",
                onTap: async () => this.refreshSession()
              }),
              App.createDUIButton({
                id: "logout",
                label: "Logout",
                onTap: async () => this.logout()
              })
            ];
          }
          return [
            App.createDUINavigationButton({
              id: "loginButton",
              label: "Login",
              form: App.createDUIForm({
                sections: async () => [
                  App.createDUISection({
                    id: "usernameSection",
                    header: "Username",
                    footer: "Enter your MangaUpdates account username",
                    isHidden: false,
                    rows: () => Promise.resolve([
                      App.createDUIInputField({
                        id: "username",
                        placeholder: "Username",
                        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                        //@ts-ignore also accepts a raw value, not just a DUIBinding
                        value: "",
                        maskInput: false
                      })
                    ])
                  }),
                  App.createDUISection({
                    id: "passwordSection",
                    header: "Password",
                    footer: "Enter the password associated with your MangaUpdates account Username",
                    isHidden: false,
                    rows: () => Promise.resolve([
                      App.createDUIInputField({
                        id: "password",
                        placeholder: "Password",
                        // eslint-disable-next-line @typescript-eslint/ban-ts-comment
                        //@ts-ignore also accepts a raw value, not just a DUIBinding
                        value: "",
                        maskInput: true
                      })
                    ])
                  })
                ],
                onSubmit: (values) => this.login(values)
              })
            })
          ];
        }
      });
    }
    async getSearchResults(query, metadata) {
      const logPrefix2 = "[getSearchResults]";
      console.log(`${logPrefix2} starts`);
      try {
        const search = query.title || "";
        const page = metadata?.nextPage ?? 1;
        const perpage = 25;
        if (!search || page < 1) {
          console.log(`${logPrefix2} no need to search: ${JSON.stringify({ search, page })}`);
          return App.createPagedResults({ results: [], metadata: { nextPage: -1 } });
        }
        console.log(`${logPrefix2} searching for "${search}" (page=${page})`);
        const response = await this.request("/v1/series/search", "POST", {
          body: {
            search,
            page,
            perpage
          }
        });
        const results = parseSearchResults(response.results || []);
        const hasNextPage = page * perpage < (response.total_hits ?? 0);
        const nextPage = hasNextPage ? page + 1 : -1;
        console.log(`${logPrefix2} got results: ${JSON.stringify({ results, nextPage })}`);
        const pagedResults = App.createPagedResults({
          results: results.map((result) => App.createPartialSourceManga(result)),
          metadata: { nextPage }
        });
        console.log(`${logPrefix2} complete`);
        return pagedResults;
      } catch (e) {
        console.log(`${logPrefix2} error`);
        console.log(e);
        throw e;
      }
    }
    async processChapterReadActionQueue(actionQueue) {
      const logPrefix2 = "[processChapterReadActionQueue]";
      console.log(`${logPrefix2} starts`);
      const chapterReadActions = await actionQueue.queuedChapterReadActions();
      console.log(`${logPrefix2} found ${chapterReadActions.length} action(s)`);
      const operations = await Promise.all(chapterReadActions.map((action) => this.parseAction(action)));
      const listUpdates = operations.filter((operation) => operation.isUpdate);
      if (listUpdates.length > 0) {
        try {
          const updateBody = listUpdates.map(({ payload }) => payload);
          console.log(`${logPrefix2} applying list updates: ${JSON.stringify(updateBody)}`);
          await this.request("/v1/lists/series/update", "POST", { body: updateBody });
          await Promise.all(listUpdates.map(({ action }) => actionQueue.discardChapterReadAction(action)));
        } catch (e) {
          console.log(`${logPrefix2} list updates failed`);
          console.log(e);
          await Promise.all(listUpdates.map(({ action }) => actionQueue.retryChapterReadAction(action)));
        }
      }
      const listAdditions = operations.filter((operation) => !operation.isUpdate);
      if (listAdditions.length > 0) {
        try {
          const additionBody = listAdditions.map(({ payload }) => payload);
          console.log(`${logPrefix2} applying list additions: ${JSON.stringify(additionBody)}`);
          await this.request("/v1/lists/series", "POST", { body: additionBody });
          await Promise.all(listAdditions.map(({ action }) => actionQueue.discardChapterReadAction(action)));
        } catch (e) {
          console.log(`${logPrefix2} list additions failed`);
          console.log(e);
          await Promise.all(listAdditions.map(({ action }) => actionQueue.retryChapterReadAction(action)));
        }
      }
      console.log(`${logPrefix2} complete`);
    }
    ////////////////////
    // Session Management
    ////////////////////
    async login(credentials) {
      const logPrefix2 = "[login]";
      console.log(`${logPrefix2} starts`);
      if (!validateCredentials(credentials)) {
        console.error(`${logPrefix2} login called with invalid credentials: ${JSON.stringify(credentials)}`);
        throw new Error("Must provide a username and password!");
      }
      try {
        const result = await this.request("/v1/account/login", "PUT", {
          body: credentials
        });
        const sessionToken = result.context?.session_token;
        if (!sessionToken) {
          console.log(`${logPrefix2} no session token on response: ${JSON.stringify(result)}`);
          throw new Error("no session token on response");
        }
        await Promise.all([
          setUserCredentials(this.stateManager, credentials),
          setSessionToken(this.stateManager, sessionToken)
        ]);
        console.log(`${logPrefix2} complete`);
      } catch (e) {
        console.log(`${logPrefix2} failed to log in`);
        console.log(e);
        throw new Error("Login failed!");
      }
    }
    async refreshSession() {
      const logPrefix2 = "[refreshSession]";
      console.log(`${logPrefix2} starts`);
      const credentials = await getUserCredentials(this.stateManager);
      if (!credentials) {
        console.log(`${logPrefix2} no credentials available, unable to refresh`);
        throw new Error("Could not find login credentials!");
      }
      await this.logout();
      await this.login(credentials);
      console.log(`${logPrefix2} complete`);
    }
    async logout() {
      try {
        await this.request("/v1/account/logout", "POST", {});
      } catch (e) {
        console.log("[logout] failed to delete session token");
        console.log(e);
      }
      await Promise.all([clearUserCredentials(this.stateManager), clearSessionToken(this.stateManager)]);
    }
    ////////////////////
    // Request Handlers
    ////////////////////
    async getMangaInfo(canonicalId) {
      const logPrefix2 = "[getMangaInfo]";
      console.log(`${logPrefix2} start: ${canonicalId}`);
      const series = await this.request("/v1/series/{id}", "GET", {
        params: { id: canonicalId },
        query: {}
      });
      const mangaInfo = parseMangaInfo(series);
      console.log(`${logPrefix2} complete: ${JSON.stringify(mangaInfo)}`);
      return mangaInfo;
    }
    async handleMangaFormChanges(mangaId, isInList, values) {
      const logPrefix2 = "[handleMangaFormChanges]";
      console.log(`${logPrefix2} starts: ${JSON.stringify(values)}`);
      try {
        const numericId = parseInt(mangaId);
        const shouldDelete = values.listId[0] === "-1";
        const actions = [];
        if (shouldDelete) {
          console.log(`${logPrefix2} deleting from list`);
          actions.push(
            this.request("/v1/lists/series/delete", "POST", {
              body: [numericId]
            })
          );
        } else {
          console.log(`${logPrefix2} updating in list`);
          actions.push(
            this.request(isInList ? "/v1/lists/series/update" : "/v1/lists/series", "POST", {
              body: [
                {
                  series: { id: numericId },
                  list_id: parseInt(values.listId[0]),
                  status: {
                    volume: values.volumeProgress,
                    chapter: values.chapterProgress
                  }
                }
              ]
            })
          );
        }
        if (values.userRating > 0) {
          actions.push(
            this.request("/v1/series/{id}/rating", "PUT", {
              params: { id: mangaId },
              body: { rating: values.userRating }
            })
          );
        } else {
          actions.push(
            this.request("/v1/series/{id}/rating", "DELETE", {
              params: { id: mangaId }
            })
          );
        }
        await Promise.all(actions);
        console.log(`${logPrefix2} complete`);
      } catch (e) {
        console.log(`${logPrefix2} failed`);
        console.log(e);
        throw e;
      }
    }
    async parseAction(action) {
      const listInfo = await this.request(
        "/v1/lists/series/{seriesId}",
        "GET",
        {
          params: { seriesId: action.mangaId },
          query: {}
        },
        false
      );
      return {
        action,
        isUpdate: !!listInfo,
        payload: {
          series: { id: parseInt(action.mangaId) },
          list_id: listInfo?.list_id ?? DEFAULT_LIST_ID,
          status: {
            volume: Math.floor(action.volumeNumber) || 1,
            chapter: Math.floor(action.chapterNumber) || 1
          }
        }
      };
    }
    ////////////////////
    // API Request
    ////////////////////
    async getAuthHeader() {
      const existingSessionToken = await getSessionToken(this.stateManager);
      if (existingSessionToken) {
        return `Bearer ${existingSessionToken}`;
      }
      const credentials = await getUserCredentials(this.stateManager);
      if (credentials) {
        await this.login(credentials);
        const newSessionToken = await getSessionToken(this.stateManager);
        if (newSessionToken) {
          return `Bearer ${newSessionToken}`;
        }
      }
      throw new Error("You must be logged in!");
    }
    /** Will **reject** if the response has a non-2xx status. */
    async request(endpoint, verb, request, failOnErrorStatus = true, retryCount = 1) {
      const logPrefix2 = `[request] ${verb} ${endpoint}`;
      const isLogin = endpoint === "/v1/account/login";
      const baseRequest = request;
      console.log(
        `${logPrefix2} starts (failOnErrorStatus=${failOnErrorStatus}, retryCount=${retryCount}): ${loggableRequest(
          baseRequest
        )}`
      );
      const path = Object.entries(baseRequest.params || {}).filter((entry) => entry[1] != void 0).map(([name, value]) => [`{${name}}`, String(value)]).reduce((partialPath, [token, value]) => {
        if (!partialPath.includes(token)) {
          console.log(`${logPrefix2} endpoint '${endpoint}' does not contain ${token}!`);
          throw new Error("endpoint is missing path parameter");
        }
        return endpoint.replace(token, String(value));
      }, endpoint);
      const query = Object.entries(baseRequest.query || {}).filter((entry) => entry[1] != void 0).map(([name, value]) => `${name}=${encodeURIComponent(String(value))}`).join("&");
      const headers = {
        accept: "application/json"
      };
      if (baseRequest.body) {
        headers["content-type"] = "application/json";
      }
      if (!isLogin) {
        headers.authorization = await this.getAuthHeader();
      }
      const start = Date.now();
      const response = await this.requestManager.schedule(
        App.createRequest({
          url: `https://api.mangaupdates.com${path}`,
          method: verb,
          param: query,
          data: baseRequest.body ? JSON.stringify(baseRequest.body) : void 0,
          headers
        }),
        retryCount
      );
      const duration = Date.now() - start;
      const responseBody = response.data ? JSON.parse(response.data) : void 0;
      console.log(
        `${logPrefix2} response: (HTTP ${response.status}, ${duration}ms): ${loggableResponse(responseBody)}`
      );
      const ok = response.status >= 200 && response.status < 300;
      if (failOnErrorStatus && !ok) {
        console.log(`${logPrefix2} failed`);
        throw new Error("Request failed!");
      }
      console.log(`${logPrefix2} complete`);
      return responseBody;
    }
  };
  return __toCommonJS(MangaUpdates_exports);
})();
this.Sources = _Sources; if (typeof exports === 'object' && typeof module !== 'undefined') {module.exports.Sources = this.Sources;}
